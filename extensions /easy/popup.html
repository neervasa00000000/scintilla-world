<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExtractFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            width: 420px;
            height: 680px;
            background: #0a0a0f;
            color: #e4e4e7;
            overflow: hidden;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
        }
        .neon-glow {
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.3), 0 0 40px rgba(139, 92, 246, 0.1);
        }
        .btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            cursor: pointer;
            user-select: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(139, 92, 246, 0.4);
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.5);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e4e4e7;
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.15);
        }
        .input-modern {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e4e4e7;
            transition: all 0.2s ease;
        }
        .input-modern:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
            outline: none;
        }
        .chip {
            animation: chipSlide 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
            transition: all 0.2s ease;
        }
        .chip:hover {
            background: rgba(139, 92, 246, 0.25);
            transform: translateY(-1px);
        }
        .chip-phone {
            background: rgba(16, 185, 129, 0.15);
            border-color: rgba(16, 185, 129, 0.3);
        }
        .chip-phone:hover {
            background: rgba(16, 185, 129, 0.25);
        }
        @keyframes chipSlide {
            from {
                opacity: 0;
                transform: scale(0.8) translateX(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateX(0);
            }
        }
        .record-card {
            animation: cardSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.2s ease;
        }
        .record-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.12);
            transform: translateX(4px);
        }
        @keyframes cardSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .scrollbar-modern::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-modern::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
        }
        .scrollbar-modern::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.3);
            border-radius: 10px;
        }
        .scrollbar-modern::-webkit-scrollbar-thumb:hover {
            background: rgba(139, 92, 246, 0.5);
        }
        [contenteditable]:empty:before {
            content: attr(data-placeholder);
            color: #71717a;
        }
        .toast {
            animation: toastSlide 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), toastFade 0.2s ease-in 2.7s forwards;
        }
        @keyframes toastSlide {
            from {
                opacity: 0;
                transform: translateX(20px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        @keyframes toastFade {
            to {
                opacity: 0;
                transform: translateX(20px) scale(0.9);
            }
        }
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .glow-effect {
            position: relative;
        }
        .glow-effect::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            border-radius: inherit;
            opacity: 0;
            filter: blur(8px);
            transition: opacity 0.3s;
            z-index: -1;
        }
        .glow-effect:hover::before {
            opacity: 0.3;
        }
        .stat-badge {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(99, 102, 241, 0.2));
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
    </style>
</head>
<body class="gradient-bg flex flex-col">
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 pointer-events-none space-y-2"></div>

    <!-- Header -->
    <div class="px-4 py-3.5 border-b border-white/5 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-white shadow-lg neon-glow">
                <i class="fa-solid fa-sparkles text-sm"></i>
            </div>
            <div>
                <h1 class="text-base font-bold text-white">ExtractFlow</h1>
                <p class="text-[10px] text-zinc-400 font-medium">AI-Powered Extraction</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="clearAll()" class="w-8 h-8 rounded-lg btn-secondary btn flex items-center justify-center text-zinc-400 hover:text-white" title="Reset">
                <i class="fa-solid fa-arrow-rotate-right text-xs"></i>
            </button>
            <button onclick="downloadCSV()" class="px-3 h-8 rounded-lg btn-primary btn text-xs font-semibold flex items-center gap-1.5">
                <i class="fa-solid fa-download text-[10px]"></i>
                <span>Export</span>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col p-3 gap-3 overflow-hidden">
        <!-- Quick Stats -->
        <div class="flex gap-2">
            <div class="flex-1 glass-card px-3 py-2.5 rounded-xl">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center">
                        <i class="fa-solid fa-envelope text-purple-400 text-xs"></i>
                    </div>
                    <div>
                        <div class="text-xs text-zinc-400">Emails</div>
                        <div class="text-sm font-bold text-white" id="emailCount">0</div>
                    </div>
                </div>
            </div>
            <div class="flex-1 glass-card px-3 py-2.5 rounded-xl">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center">
                        <i class="fa-solid fa-phone text-emerald-400 text-xs"></i>
                    </div>
                    <div>
                        <div class="text-xs text-zinc-400">Phones</div>
                        <div class="text-sm font-bold text-white" id="phoneCount">0</div>
                    </div>
                </div>
            </div>
            <div class="flex-1 glass-card px-3 py-2.5 rounded-xl">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center">
                        <i class="fa-solid fa-database text-blue-400 text-xs"></i>
                    </div>
                    <div>
                        <div class="text-xs text-zinc-400">Records</div>
                        <div class="text-sm font-bold text-white" id="count">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Section -->
        <div class="glass-card p-3.5 rounded-xl flex flex-col gap-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-paste text-purple-400 text-xs"></i>
                    <span class="text-xs font-semibold text-zinc-300">Text Input</span>
                </div>
                <button onclick="loadSampleData()" class="px-2.5 py-1 rounded-lg btn-secondary text-[10px] font-medium btn">
                    Sample
                </button>
            </div>
            <div class="relative">
                <div id="pasteArea" 
                     contenteditable="true" 
                     class="input-modern rounded-lg p-3 min-h-[100px] max-h-[100px] overflow-y-auto scrollbar-modern text-sm resize-none"
                     data-placeholder="Paste or type text here..."></div>
            </div>
        </div>

        <!-- Extracted Data -->
        <div class="glass-card p-3.5 rounded-xl flex flex-col gap-3">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-xs font-bold text-white">Extracted Data</h3>
                    <p class="text-[10px] text-zinc-400 mt-0.5">Review and add</p>
                </div>
                <div class="flex gap-1.5">
                    <button onclick="clearInputs()" class="w-7 h-7 rounded-lg btn-secondary btn flex items-center justify-center text-zinc-400 hover:text-white" title="Clear">
                        <i class="fa-solid fa-eraser text-[10px]"></i>
                    </button>
                    <button onclick="addRecord()" id="addBtn" class="px-3 h-7 rounded-lg btn-primary btn text-xs font-semibold flex items-center gap-1.5 glow-effect">
                        <i class="fa-solid fa-plus text-[10px]"></i>
                        <span>Add</span>
                    </button>
                </div>
            </div>

            <!-- Name Inputs -->
            <div class="grid grid-cols-2 gap-2">
                <div class="relative">
                    <label class="absolute -top-2 left-2 bg-[#0a0a0f] px-1.5 text-[10px] font-semibold text-zinc-400">First Name</label>
                    <input type="text" id="firstName" class="input-modern w-full rounded-lg p-2.5 text-sm" placeholder="John">
                </div>
                <div class="relative">
                    <label class="absolute -top-2 left-2 bg-[#0a0a0f] px-1.5 text-[10px] font-semibold text-zinc-400">Last Name</label>
                    <input type="text" id="lastName" class="input-modern w-full rounded-lg p-2.5 text-sm" placeholder="Doe">
                </div>
            </div>

            <!-- Email Chips -->
            <div class="relative">
                <div class="absolute -top-2 left-2 bg-[#0a0a0f] px-1.5 flex items-center gap-1.5 z-10">
                    <i class="fa-solid fa-envelope text-purple-400 text-[10px]"></i>
                    <span class="text-[10px] font-semibold text-zinc-400">Emails</span>
                </div>
                <div id="emailList" class="input-modern rounded-lg p-2.5 min-h-[60px] flex flex-wrap gap-2">
                    <span class="text-xs text-zinc-500 italic w-full">No emails detected...</span>
                </div>
            </div>

            <!-- Phone Chips -->
            <div class="relative">
                <div class="absolute -top-2 left-2 bg-[#0a0a0f] px-1.5 flex items-center gap-1.5 z-10">
                    <i class="fa-solid fa-phone text-emerald-400 text-[10px]"></i>
                    <span class="text-[10px] font-semibold text-zinc-400">Phones</span>
                </div>
                <div id="phoneList" class="input-modern rounded-lg p-2.5 min-h-[60px] flex flex-wrap gap-2">
                    <span class="text-xs text-zinc-500 italic w-full">No phones detected...</span>
                </div>
            </div>
        </div>

        <!-- Records List -->
        <div class="glass-card flex-1 flex flex-col overflow-hidden rounded-xl min-h-0">
            <div class="px-3.5 py-2.5 flex items-center justify-between border-b border-white/5">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-list text-zinc-400 text-xs"></i>
                    <span class="text-xs font-semibold text-zinc-300">Saved Records</span>
                </div>
                <div class="px-2.5 py-1 rounded-full stat-badge text-white text-[10px] font-bold" id="countDisplay">0</div>
            </div>
            
            <div class="flex-1 overflow-y-auto scrollbar-modern p-2.5">
                <div id="emptyState" class="h-full flex flex-col items-center justify-center text-zinc-500 p-6">
                    <div class="w-16 h-16 rounded-full bg-zinc-800/50 flex items-center justify-center mb-3 border border-white/5">
                        <i class="fa-solid fa-inbox text-2xl text-zinc-600"></i>
                    </div>
                    <p class="text-xs font-semibold text-zinc-400 mb-1">No records yet</p>
                    <p class="text-[10px] text-zinc-500 text-center max-w-[200px]">Extract data and add your first record</p>
                </div>
                <div id="recordsList" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="floatMenu" class="fixed hidden glass-card rounded-xl shadow-2xl p-2 z-50 border border-white/10">
        <button onclick="assignName()" class="px-4 py-2 rounded-lg bg-purple-500/20 hover:bg-purple-500/30 text-purple-300 text-xs font-semibold btn flex items-center gap-2 border border-purple-500/30">
            <i class="fa-solid fa-user-check text-[10px]"></i>
            <span>Assign Name</span>
        </button>
    </div>

    <script>
        // State
        const state = {
            records: [],
            currentEmails: new Set(),
            currentPhones: new Set(),
            selection: ""
        };

        // DOM
        const el = {
            pasteArea: document.getElementById('pasteArea'),
            floatMenu: document.getElementById('floatMenu'),
            recordsList: document.getElementById('recordsList'),
            emptyState: document.getElementById('emptyState'),
            countSpan: document.getElementById('count'),
            countDisplay: document.getElementById('countDisplay'),
            toastContainer: document.getElementById('toastContainer'),
            inputs: { first: document.getElementById('firstName'), last: document.getElementById('lastName') },
            lists: { email: document.getElementById('emailList'), phone: document.getElementById('phoneList') },
            counts: { email: document.getElementById('emailCount'), phone: document.getElementById('phoneCount') }
        };

        const patterns = {
            email: /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,
            phone: /(?:(?:\+?61|0)[2-478](?:[ -]?[0-9]){8})|(?:\+?61|0)4(?:[ -]?[0-9]){8}|(?:\(0[2-478]\)(?:[ -]?[0-9]){8})|\b\d{4}[ -]?\d{3}[ -]?\d{3}\b/g
        };

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const colors = {
                success: { bg: 'bg-emerald-500', icon: 'fa-check-circle' },
                error: { bg: 'bg-red-500', icon: 'fa-exclamation-circle' },
                info: { bg: 'bg-blue-500', icon: 'fa-info-circle' }
            };
            const color = colors[type] || colors.success;
            toast.className = `toast ${color.bg} px-4 py-2.5 rounded-lg shadow-xl mb-2 pointer-events-auto`;
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fa-solid ${color.icon} text-xs"></i>
                    <span class="text-xs font-semibold">${message}</span>
                </div>
            `;
            el.toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Load saved data
        chrome.storage.local.get(['extractflow_records'], (result) => {
            if (result.extractflow_records) {
                state.records = result.extractflow_records;
                renderRecords();
            }
        });

        // Functions
        function loadSampleData() {
            const sample = `INVOICE #001
To: Elon Musk
Contact: elon@mars.x
Phone: 0499 123 456

INVOICE #002
To: Jeff Bezos
Email: jeff@amazon.prime
Direct: (02) 9911 2233`;
            el.pasteArea.innerText = sample;
            scanText(sample);
            showToast('Sample data loaded', 'info');
        }

        el.pasteArea.addEventListener('paste', (e) => {
            const text = (e.clipboardData || window.clipboardData).getData('text');
            setTimeout(() => scanText(el.pasteArea.innerText), 50);
        });

        el.pasteArea.addEventListener('input', () => {
            scanText(el.pasteArea.innerText);
        });

        function scanText(text) {
            if(!text) return;
            const emails = text.match(patterns.email) || [];
            const phones = text.match(patterns.phone) || [];
            let added = 0;
            
            emails.forEach(e => {
                if(!state.currentEmails.has(e.trim())) { 
                    state.currentEmails.add(e.trim()); 
                    added++; 
                }
            });
            
            phones.forEach(p => {
                const clean = p.trim();
                if(clean.length > 6 && !state.currentPhones.has(clean)) { 
                    state.currentPhones.add(clean); 
                    added++; 
                }
            });
            
            if(added > 0) {
                renderChips();
                updateStats();
            }
        }

        function updateStats() {
            el.counts.email.innerText = state.currentEmails.size;
            el.counts.phone.innerText = state.currentPhones.size;
        }

        document.addEventListener('mouseup', (e) => {
            const sel = window.getSelection();
            const text = sel.toString().trim();
            if(text.length > 0 && el.pasteArea.contains(sel.anchorNode)) {
                state.selection = text;
                const rect = sel.getRangeAt(0).getBoundingClientRect();
                el.floatMenu.style.display = 'block';
                el.floatMenu.style.left = `${rect.left + (rect.width/2) - 70}px`;
                el.floatMenu.style.top = `${rect.top - 45}px`;
            } else if (!el.floatMenu.contains(e.target)) {
                el.floatMenu.style.display = 'none';
            }
        });

        function assignName() {
            const parts = state.selection.split(' ');
            el.inputs.first.value = parts[0] || '';
            el.inputs.last.value = parts.slice(1).join(' ') || '';
            el.floatMenu.style.display = 'none';
            window.getSelection().removeAllRanges();
            el.inputs.first.focus();
            showToast('Name assigned', 'success');
        }

        function renderChips() {
            renderList(el.lists.email, state.currentEmails, 'chip');
            renderList(el.lists.phone, state.currentPhones, 'chip chip-phone');
        }

        function renderList(container, set, chipClass) {
            container.innerHTML = '';
            if(set.size === 0) {
                container.innerHTML = '<span class="text-xs text-zinc-500 italic">No data...</span>';
                return;
            }
            set.forEach(item => {
                const div = document.createElement('div');
                div.className = `${chipClass} px-2.5 py-1.5 rounded-lg text-xs font-medium flex items-center gap-2 cursor-pointer text-white`;
                div.innerHTML = `
                    <span class="flex-1">${item}</span>
                    <i class="fa-solid fa-xmark text-[10px] opacity-60 hover:opacity-100"></i>
                `;
                div.onclick = (e) => {
                    e.stopPropagation();
                    set.delete(item); 
                    renderChips();
                    updateStats();
                    showToast('Removed', 'info');
                };
                container.appendChild(div);
            });
        }

        function addRecord() {
            const f = el.inputs.first.value.trim();
            const l = el.inputs.last.value.trim();
            if(!f && state.currentEmails.size === 0 && state.currentPhones.size === 0) {
                showToast('Add at least one field', 'error');
                return;
            }
            
            const btn = document.getElementById('addBtn');
            btn.style.transform = 'scale(0.95)';
            setTimeout(() => btn.style.transform = '', 150);
            
            state.records.push({
                id: Date.now(),
                f, l, 
                emails: Array.from(state.currentEmails),
                phones: Array.from(state.currentPhones)
            });
            
            renderRecords();
            clearInputs();
            chrome.storage.local.set({ extractflow_records: state.records });
            showToast('Record added', 'success');
        }

        function renderRecords() {
            el.recordsList.innerHTML = '';
            const count = state.records.length;
            el.countSpan.innerText = count;
            el.countDisplay.innerText = count;
            el.emptyState.style.display = count ? 'none' : 'flex';
            
            state.records.forEach((r, index) => {
                const div = document.createElement('div');
                div.className = 'record-card rounded-lg p-3';
                div.style.animationDelay = `${index * 0.03}s`;
                
                const eChips = r.emails.map(e => 
                    `<span class="inline-flex items-center px-2 py-1 rounded-md bg-purple-500/20 text-purple-300 text-[10px] font-medium border border-purple-500/30 mr-1 mb-1">${e}</span>`
                ).join('');
                
                const pChips = r.phones.map(p => 
                    `<span class="inline-flex items-center px-2 py-1 rounded-md bg-emerald-500/20 text-emerald-300 text-[10px] font-medium border border-emerald-500/30 mr-1 mb-1">${p}</span>`
                ).join('');

                div.innerHTML = `
                    <div class="flex items-start justify-between gap-2">
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-sm text-white mb-2">${r.f || 'Unknown'} ${r.l || ''}</div>
                            <div class="flex flex-wrap gap-1">
                                ${eChips} ${pChips}
                            </div>
                        </div>
                        <button onclick="deleteRec(${r.id})" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500/30 active:bg-red-500/40 text-red-400 flex items-center justify-center text-xs btn flex-shrink-0 border border-red-500/30">
                            <i class="fa-solid fa-trash text-[10px]"></i>
                        </button>
                    </div>
                `;
                el.recordsList.appendChild(div);
            });
        }

        function deleteRec(id) {
            state.records = state.records.filter(r => r.id !== id);
            renderRecords();
            chrome.storage.local.set({ extractflow_records: state.records });
            showToast('Record deleted', 'info');
        }

        function clearInputs() {
            el.inputs.first.value = '';
            el.inputs.last.value = '';
            state.currentEmails.clear();
            state.currentPhones.clear();
            renderChips();
            updateStats();
        }

        function clearAll() {
            if(confirm("Clear all data? This cannot be undone.")) {
                state.records = [];
                renderRecords();
                clearInputs();
                el.pasteArea.innerText = '';
                chrome.storage.local.remove('extractflow_records');
                showToast('All data cleared', 'info');
            }
        }

        function downloadCSV() {
            if(!state.records.length) {
                showToast('No records to export', 'error');
                return;
            }
            const csv = [
                'First Name,Last Name,Emails,Phones',
                ...state.records.map(r => 
                    `"${r.f}","${r.l}","${r.emails.join('; ')}","${r.phones.join('; ')}"`
                )
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `extractflow_${Date.now()}.csv`;
            link.click();
            showToast('CSV exported', 'success');
        }
    </script>
</body>
</html>
