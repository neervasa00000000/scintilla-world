<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExtractFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', sans-serif;
            width: 480px;
            height: 640px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }
        .glass {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0, 0, 0, 0.04);
        }
        .card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }
        .btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            cursor: pointer;
            user-select: none;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        .btn-primary:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        .input-field {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1.5px solid #e5e7eb;
        }
        .input-field:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.08);
            outline: none;
        }
        .chip {
            animation: chipIn 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .chip:hover {
            transform: translateY(-1px) scale(1.02);
        }
        @keyframes chipIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-4px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        .record-item {
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }
        .scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar::-webkit-scrollbar-track {
            background: #f8fafc;
            border-radius: 10px;
        }
        .scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
            transition: background 0.2s;
        }
        .scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        [contenteditable]:empty:before {
            content: attr(data-placeholder);
            color: #94a3b8;
        }
        .toast {
            animation: toastIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), toastOut 0.2s ease-in 2.7s forwards;
        }
        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        @keyframes toastOut {
            to {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
        }
        .pulse-ring {
            animation: pulseRing 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulseRing {
            0%, 100% {
                opacity: 0.4;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="flex flex-col">
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 pointer-events-none"></div>

    <!-- Header -->
    <div class="glass px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-2.5">
            <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-purple-500 via-indigo-500 to-purple-600 flex items-center justify-center text-white shadow-lg shadow-purple-500/30">
                <i class="fa-solid fa-wand-magic-sparkles text-sm"></i>
            </div>
            <div>
                <h1 class="text-sm font-bold text-gray-900 leading-tight">ExtractFlow</h1>
                <p class="text-[10px] text-gray-500 font-medium">Smart Data Extractor</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="clearAll()" class="w-8 h-8 rounded-lg bg-gray-100 hover:bg-gray-200 active:bg-gray-300 flex items-center justify-center text-gray-600 text-xs btn" title="Reset All">
                <i class="fa-solid fa-rotate-right"></i>
            </button>
            <button onclick="downloadCSV()" class="px-3 h-8 rounded-lg btn-primary text-xs btn flex items-center gap-1.5 font-semibold">
                <i class="fa-solid fa-download text-[10px]"></i>
                <span>Export</span>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col p-3 gap-2.5 overflow-hidden">
        <!-- Input Section -->
        <div class="card p-3 flex flex-col gap-2.5 flex-shrink-0">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="w-6 h-6 rounded-lg bg-purple-50 flex items-center justify-center">
                        <i class="fa-solid fa-paste text-purple-600 text-xs"></i>
                    </div>
                    <span class="text-xs font-semibold text-gray-800">Paste Text</span>
                </div>
                <button onclick="loadSampleData()" class="text-[10px] px-2.5 py-1 rounded-lg bg-purple-50 hover:bg-purple-100 active:bg-purple-200 text-purple-600 font-semibold btn transition-colors">
                    Sample
                </button>
            </div>
            <div class="relative">
                <div id="pasteArea" 
                     contenteditable="true" 
                     class="input-field rounded-lg p-3 min-h-[90px] max-h-[90px] overflow-y-auto scrollbar text-sm text-gray-700 bg-gray-50 focus:bg-white resize-none"
                     data-placeholder="Paste your text here..."></div>
            </div>
        </div>

        <!-- Extracted Data Section -->
        <div class="card p-3 flex flex-col gap-3 flex-shrink-0">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-xs font-bold text-gray-900">Detected Data</h3>
                    <p class="text-[10px] text-gray-500 mt-0.5">Review and add to records</p>
                </div>
                <div class="flex gap-1.5">
                    <button onclick="clearInputs()" class="w-7 h-7 rounded-lg bg-gray-100 hover:bg-gray-200 active:bg-gray-300 flex items-center justify-center text-gray-600 text-xs btn" title="Clear">
                        <i class="fa-solid fa-eraser text-[10px]"></i>
                    </button>
                    <button onclick="addRecord()" id="addBtn" class="px-3 h-7 rounded-lg btn-primary text-xs btn flex items-center gap-1.5 font-semibold">
                        <i class="fa-solid fa-plus text-[10px]"></i>
                        <span>Add</span>
                    </button>
                </div>
            </div>

            <!-- Name Inputs -->
            <div class="grid grid-cols-2 gap-2">
                <div class="relative">
                    <label class="absolute -top-2 left-2 bg-white px-1.5 text-[10px] font-semibold text-gray-600">First Name</label>
                    <input type="text" id="firstName" class="input-field w-full rounded-lg p-2.5 text-sm bg-gray-50 focus:bg-white" placeholder="John">
                </div>
                <div class="relative">
                    <label class="absolute -top-2 left-2 bg-white px-1.5 text-[10px] font-semibold text-gray-600">Last Name</label>
                    <input type="text" id="lastName" class="input-field w-full rounded-lg p-2.5 text-sm bg-gray-50 focus:bg-white" placeholder="Doe">
                </div>
            </div>

            <!-- Email Chips -->
            <div class="relative">
                <div class="absolute -top-2 left-2 bg-white px-1.5 flex items-center gap-1.5 z-10">
                    <i class="fa-solid fa-envelope text-purple-500 text-[10px]"></i>
                    <span class="text-[10px] font-semibold text-gray-600">Emails</span>
                    <span id="emailCount" class="text-[10px] font-bold text-white bg-purple-500 px-1.5 py-0.5 rounded-full min-w-[18px] text-center">0</span>
                </div>
                <div id="emailList" class="input-field rounded-lg p-2.5 min-h-[56px] flex flex-wrap gap-1.5 bg-gray-50 focus-within:bg-white">
                    <span class="text-xs text-gray-400 italic w-full">No emails found...</span>
                </div>
            </div>

            <!-- Phone Chips -->
            <div class="relative">
                <div class="absolute -top-2 left-2 bg-white px-1.5 flex items-center gap-1.5 z-10">
                    <i class="fa-solid fa-phone text-emerald-500 text-[10px]"></i>
                    <span class="text-[10px] font-semibold text-gray-600">Phones</span>
                    <span id="phoneCount" class="text-[10px] font-bold text-white bg-emerald-500 px-1.5 py-0.5 rounded-full min-w-[18px] text-center">0</span>
                </div>
                <div id="phoneList" class="input-field rounded-lg p-2.5 min-h-[56px] flex flex-wrap gap-1.5 bg-gray-50 focus-within:bg-white">
                    <span class="text-xs text-gray-400 italic w-full">No phones found...</span>
                </div>
            </div>
        </div>

        <!-- Records List -->
        <div class="card flex-1 flex flex-col overflow-hidden min-h-0">
            <div class="px-3 py-2.5 flex items-center justify-between border-b border-gray-100">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-database text-gray-400 text-xs"></i>
                    <span class="text-xs font-semibold text-gray-700">Records</span>
                </div>
                <div class="px-2.5 py-1 rounded-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white text-[10px] font-bold shadow-sm" id="count">0</div>
            </div>
            
            <div class="flex-1 overflow-y-auto scrollbar p-2.5">
                <div id="emptyState" class="h-full flex flex-col items-center justify-center text-gray-400 p-6">
                    <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mb-3">
                        <i class="fa-solid fa-inbox text-2xl text-gray-300"></i>
                    </div>
                    <p class="text-xs font-semibold text-gray-500 mb-1">No records yet</p>
                    <p class="text-[10px] text-gray-400 text-center max-w-[200px]">Extract data from text and add your first record</p>
                </div>
                <div id="recordsList" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="floatMenu" class="fixed hidden bg-white rounded-xl shadow-2xl border border-gray-200 p-2 z-50">
        <button onclick="assignName()" class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-50 to-indigo-50 hover:from-purple-100 hover:to-indigo-100 text-purple-600 text-xs font-semibold btn flex items-center gap-2 transition-all">
            <i class="fa-solid fa-user-check text-[10px]"></i>
            <span>Assign Name</span>
        </button>
    </div>

    <script>
        // State
        const state = {
            records: [],
            currentEmails: new Set(),
            currentPhones: new Set(),
            selection: ""
        };

        // DOM
        const el = {
            pasteArea: document.getElementById('pasteArea'),
            floatMenu: document.getElementById('floatMenu'),
            recordsList: document.getElementById('recordsList'),
            emptyState: document.getElementById('emptyState'),
            countSpan: document.getElementById('count'),
            toastContainer: document.getElementById('toastContainer'),
            inputs: { first: document.getElementById('firstName'), last: document.getElementById('lastName') },
            lists: { email: document.getElementById('emailList'), phone: document.getElementById('phoneList') },
            counts: { email: document.getElementById('emailCount'), phone: document.getElementById('phoneCount') }
        };

        const patterns = {
            email: /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,
            phone: /(?:(?:\+?61|0)[2-478](?:[ -]?[0-9]){8})|(?:\+?61|0)4(?:[ -]?[0-9]){8}|(?:\(0[2-478]\)(?:[ -]?[0-9]){8})|\b\d{4}[ -]?\d{3}[ -]?\d{3}\b/g
        };

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast px-4 py-2.5 rounded-lg shadow-lg mb-2 pointer-events-auto ${
                type === 'success' ? 'bg-emerald-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} text-xs"></i>
                    <span class="text-xs font-semibold">${message}</span>
                </div>
            `;
            el.toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Load saved data
        chrome.storage.local.get(['extractflow_records'], (result) => {
            if (result.extractflow_records) {
                state.records = result.extractflow_records;
                renderRecords();
            }
        });

        // Functions
        function loadSampleData() {
            const sample = `INVOICE #001
To: Elon Musk
Contact: elon@mars.x
Phone: 0499 123 456

INVOICE #002
To: Jeff Bezos
Email: jeff@amazon.prime
Direct: (02) 9911 2233`;
            el.pasteArea.innerText = sample;
            scanText(sample);
            showToast('Sample data loaded', 'info');
        }

        el.pasteArea.addEventListener('paste', (e) => {
            const text = (e.clipboardData || window.clipboardData).getData('text');
            setTimeout(() => scanText(el.pasteArea.innerText), 50);
        });

        el.pasteArea.addEventListener('input', () => {
            scanText(el.pasteArea.innerText);
        });

        function scanText(text) {
            if(!text) return;
            const emails = text.match(patterns.email) || [];
            const phones = text.match(patterns.phone) || [];
            let added = 0;
            
            emails.forEach(e => {
                if(!state.currentEmails.has(e.trim())) { 
                    state.currentEmails.add(e.trim()); 
                    added++; 
                }
            });
            
            phones.forEach(p => {
                const clean = p.trim();
                if(clean.length > 6 && !state.currentPhones.has(clean)) { 
                    state.currentPhones.add(clean); 
                    added++; 
                }
            });
            
            if(added > 0) {
                renderChips();
            }
        }

        document.addEventListener('mouseup', (e) => {
            const sel = window.getSelection();
            const text = sel.toString().trim();
            if(text.length > 0 && el.pasteArea.contains(sel.anchorNode)) {
                state.selection = text;
                const rect = sel.getRangeAt(0).getBoundingClientRect();
                el.floatMenu.style.display = 'block';
                el.floatMenu.style.left = `${rect.left + (rect.width/2) - 70}px`;
                el.floatMenu.style.top = `${rect.top - 45}px`;
            } else if (!el.floatMenu.contains(e.target)) {
                el.floatMenu.style.display = 'none';
            }
        });

        function assignName() {
            const parts = state.selection.split(' ');
            el.inputs.first.value = parts[0] || '';
            el.inputs.last.value = parts.slice(1).join(' ') || '';
            el.floatMenu.style.display = 'none';
            window.getSelection().removeAllRanges();
            el.inputs.first.focus();
            showToast('Name assigned', 'success');
        }

        function renderChips() {
            renderList(el.lists.email, state.currentEmails, 'bg-purple-50 text-purple-700 border-purple-200');
            renderList(el.lists.phone, state.currentPhones, 'bg-emerald-50 text-emerald-700 border-emerald-200');
            el.counts.email.innerText = state.currentEmails.size;
            el.counts.phone.innerText = state.currentPhones.size;
        }

        function renderList(container, set, colorClass) {
            container.innerHTML = '';
            if(set.size === 0) {
                container.innerHTML = '<span class="text-xs text-gray-400 italic">No data...</span>';
                return;
            }
            set.forEach(item => {
                const div = document.createElement('div');
                div.className = `chip px-2.5 py-1.5 rounded-lg text-xs font-medium border ${colorClass} flex items-center gap-2 cursor-pointer hover:shadow-sm`;
                div.innerHTML = `
                    <span class="flex-1">${item}</span>
                    <i class="fa-solid fa-xmark text-[10px] opacity-50 hover:opacity-100"></i>
                `;
                div.onclick = (e) => {
                    e.stopPropagation();
                    set.delete(item); 
                    renderChips();
                    showToast('Removed', 'info');
                };
                container.appendChild(div);
            });
        }

        function addRecord() {
            const f = el.inputs.first.value.trim();
            const l = el.inputs.last.value.trim();
            if(!f && state.currentEmails.size === 0 && state.currentPhones.size === 0) {
                showToast('Please add at least one field', 'error');
                return;
            }
            
            // Button animation
            const btn = document.getElementById('addBtn');
            btn.style.transform = 'scale(0.95)';
            setTimeout(() => btn.style.transform = '', 150);
            
            state.records.push({
                id: Date.now(),
                f, l, 
                emails: Array.from(state.currentEmails),
                phones: Array.from(state.currentPhones)
            });
            
            renderRecords();
            clearInputs();
            chrome.storage.local.set({ extractflow_records: state.records });
            showToast('Record added successfully', 'success');
        }

        function renderRecords() {
            el.recordsList.innerHTML = '';
            el.countSpan.innerText = state.records.length;
            el.emptyState.style.display = state.records.length ? 'none' : 'flex';
            
            state.records.forEach((r, index) => {
                const div = document.createElement('div');
                div.className = 'record-item card p-3 hover:shadow-md transition-all';
                div.style.animationDelay = `${index * 0.05}s`;
                
                const eChips = r.emails.map(e => 
                    `<span class="inline-flex items-center px-2 py-0.5 rounded-md bg-purple-50 text-purple-700 text-[10px] font-medium border border-purple-200 mr-1 mb-1">${e}</span>`
                ).join('');
                
                const pChips = r.phones.map(p => 
                    `<span class="inline-flex items-center px-2 py-0.5 rounded-md bg-emerald-50 text-emerald-700 text-[10px] font-medium border border-emerald-200 mr-1 mb-1">${p}</span>`
                ).join('');

                div.innerHTML = `
                    <div class="flex items-start justify-between gap-2">
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-sm text-gray-900 mb-2">${r.f || 'Unknown'} ${r.l || ''}</div>
                            <div class="flex flex-wrap gap-1">
                                ${eChips} ${pChips}
                            </div>
                        </div>
                        <button onclick="deleteRec(${r.id})" class="w-7 h-7 rounded-lg bg-red-50 hover:bg-red-100 active:bg-red-200 text-red-600 flex items-center justify-center text-xs btn flex-shrink-0 transition-colors">
                            <i class="fa-solid fa-trash text-[10px]"></i>
                        </button>
                    </div>
                `;
                el.recordsList.appendChild(div);
            });
        }

        function deleteRec(id) {
            state.records = state.records.filter(r => r.id !== id);
            renderRecords();
            chrome.storage.local.set({ extractflow_records: state.records });
            showToast('Record deleted', 'info');
        }

        function clearInputs() {
            el.inputs.first.value = '';
            el.inputs.last.value = '';
            state.currentEmails.clear();
            state.currentPhones.clear();
            renderChips();
        }

        function clearAll() {
            if(confirm("Clear all data? This cannot be undone.")) {
                state.records = [];
                renderRecords();
                clearInputs();
                el.pasteArea.innerText = '';
                chrome.storage.local.remove('extractflow_records');
                showToast('All data cleared', 'info');
            }
        }

        function downloadCSV() {
            if(!state.records.length) {
                showToast('No records to export', 'error');
                return;
            }
            const csv = [
                'First Name,Last Name,Emails,Phones',
                ...state.records.map(r => 
                    `"${r.f}","${r.l}","${r.emails.join('; ')}","${r.phones.join('; ')}"`
                )
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `extractflow_${Date.now()}.csv`;
            link.click();
            showToast('CSV exported successfully', 'success');
        }
    </script>
</body>
</html>
